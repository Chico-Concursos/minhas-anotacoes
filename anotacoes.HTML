<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Minhas Anotações</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      background-color: black;
      color: #FFD700;
      font-family: Arial, sans-serif;
      text-align: center;
    }
    .top-bar {
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: #111;
      padding: 10px;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 5px;
    }
    .top-bar button,
    .top-bar select,
    .top-bar input {
      background: none;
      border: none;
      color: white;
      font-size: 1.0em;
      cursor: pointer;
      position: relative;
    }
    .top-bar input[type="text"] {
      border: 1px solid #555;
      border-radius: 4px;
      padding: 2px 5px;
      background-color: #222;
    }
    .top-bar span {
      font-size: 1.0em;
      color: white;
    }
    .top-bar select {
      background-color: #222;
      border: 1px solid #555;
      padding: 2px 4px;
    }
    /* Tooltip para botões do topo */
    .tooltip:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      top: 120%;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: #fff;
      padding: 5px 8px;
      border-radius: 4px;
      white-space: nowrap;
      font-size: 0.8em;
      z-index: 10;
    }
    #main-container {
      background-color: white;
      color: black;
      width: 96%;
      height: 70vh;
      margin: 20px auto;
      margin-top: 3px;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
      display: flex;
      overflow: hidden; /* Esconde scrollbars internos */
    }
    #notes-list-container {
      width: 30%;
      border-right: 1px solid #ccc;
      overflow-y: auto;
      padding-right: 10px;
    }
    #notes-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .note-item {
      padding: 10px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      text-align: left;
    }
    .note-item:hover {
      background-color: #f0f0f0;
    }
    .note-item.active {
      background-color: #e0e0e0;
      font-weight: bold;
    }
    .note-title {
      font-weight: bold;
      margin-bottom: 5px;
    }
    .note-category {
      font-size: 0.8em;
      color: #666;
    }
    #note-detail-container {
      width: 70%;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    #note-detail-content {
      flex-grow: 1;
      white-space: pre-wrap; /* Preserva quebras de linha */
      text-align: left;
      margin-bottom: 20px;
    }
    #note-detail-title {
      font-size: 1.5em;
      font-weight: bold;
      margin-bottom: 10px;
    }
    #note-detail-category {
      font-size: 0.9em;
      color: #888;
      margin-bottom: 15px;
    }
    #note-form-container {
      display: none; /* Inicialmente escondido */
      width: 100%;
      padding: 20px;
      overflow-y: auto;
    }
    #note-form {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      width: 100%;
    }
    #note-form input[type="text"],
    #note-form textarea {
      width: 100%;
      padding: 8px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-family: Arial, sans-serif; /* Para consistência */
    }
    #note-form textarea {
      height: 200px; /* Altura fixa para o conteúdo */
      resize: vertical; /* Permite redimensionar verticalmente */
    }
    #note-form button {
      background-color: gold;
      color: black;
      border: none;
      padding: 10px 20px;
      margin: 5px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1em;
    }
    #note-form button:hover {
      background-color: #e5c300;
    }
    .bottom-bar {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 20px 0;
      flex-wrap: wrap;
      gap: 10px;
    }
    .bottom-bar button {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.4em;
      color: white;
      position: relative;
    }
    /* Tooltip para botões da base - aparece e some com JS */
    .bottom-bar button::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 120%;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: #fff;
      padding: 4px 6px;
      border-radius: 4px;
      font-size: 0.75em;
      white-space: nowrap;
      z-index: 10;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    .bottom-bar button.show-tooltip::after {
      opacity: 1;
    }
    #loading-message {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100%;
      font-size: 1.2em;
    }
    #error-message {
      color: red;
      font-weight: bold;
      padding: 20px;
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <button class="tooltip" data-tooltip="Nova Anotação" onclick="openAddNoteForm()">➕</button>
    <input type="text" id="searchInput" placeholder="Buscar..." oninput="filterNotes()" />
    <select id="categoryFilter" onchange="filterNotes()">
      <option value="">Todas as Categorias</option>
      <!-- As opções de categoria serão preenchidas dinamicamente -->
    </select>
    <span id="noteCounter">0 anotações</span>
  </div>

  <div id="main-container">
    <div id="loading-message">Carregando anotações...</div>
    <div id="error-message" style="display:none;"></div>

    <!-- Área de Listagem -->
    <div id="notes-list-container" style="display:none;">
      <ul id="notes-list"></ul>
    </div>

    <!-- Área de Detalhes -->
    <div id="note-detail-container" style="display:none;">
      <div id="note-detail-title"></div>
      <div id="note-detail-category"></div>
      <div id="note-detail-content"></div>
      <div>
        <button onclick="openEditNoteForm(currentNoteId)">Editar</button>
        <button onclick="deleteNote(currentNoteId)">Excluir</button>
      </div>
    </div>

    <!-- Formulário de Adição/Edição -->
    <div id="note-form-container">
      <form id="note-form">
        <input type="hidden" id="form-note-id" value="">
        <input type="text" id="form-note-title" placeholder="Título" required />
        <input type="text" id="form-note-category" placeholder="Categoria" />
        <textarea id="form-note-content" placeholder="Conteúdo (use '↳' para quebras de linha)"></textarea>
        <div>
          <button type="submit">Salvar</button>
          <button type="button" onclick="cancelForm()">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <div class="bottom-bar">
    <!-- Espaço reservado para futuros botões -->
  </div>

  <script>
    // --- CONFIGURAÇÃO INICIAL ---
    // Função para obter parâmetros da URL
    function getQueryParam(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }

    // Obter a URL do Web App da URL
    const WEB_APP_URL = getQueryParam('webAppUrl');

    // --- VARIÁVEIS GLOBAIS ---
    let allNotes = []; // Armazena todas as anotações carregadas
    let filteredNotes = []; // Armazena anotações filtradas
    let currentNoteId = null; // ID da anotação atualmente selecionada

    // --- FUNÇÕES DE INTERFACE ---
    function showSection(sectionId) {
      document.getElementById('notes-list-container').style.display = 'none';
      document.getElementById('note-detail-container').style.display = 'none';
      document.getElementById('note-form-container').style.display = 'none';
      document.getElementById('loading-message').style.display = 'none';
      document.getElementById('error-message').style.display = 'none';

      if (sectionId) {
        document.getElementById(sectionId).style.display = 'block';
      }
    }

    function displayErrorMessage(message) {
      document.getElementById('error-message').textContent = message;
      document.getElementById('error-message').style.display = 'block';
      showSection(); // Esconde outras seções
    }

    function updateNoteCounter() {
      const counterElement = document.getElementById('noteCounter');
      counterElement.textContent = `${filteredNotes.length} anotaç${filteredNotes.length === 1 ? 'ão' : 'ões'}`;
    }

    function populateCategoryFilter() {
      const categories = [...new Set(allNotes.map(note => note.category).filter(cat => cat))];
      const filterSelect = document.getElementById('categoryFilter');
      filterSelect.innerHTML = '<option value="">Todas as Categorias</option>'; // Limpa e adiciona opção padrão
      categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        filterSelect.appendChild(option);
      });
    }

    // --- FUNÇÕES DE EXIBIÇÃO DE DADOS ---
    function displayNotesList() {
       const listElement = document.getElementById('notes-list');
       listElement.innerHTML = ''; // Limpa a lista

       filteredNotes.forEach(note => {
         const listItem = document.createElement('li');
         listItem.className = 'note-item';
         if (note.id === currentNoteId) {
             listItem.classList.add('active');
         }
         listItem.dataset.id = note.id;
         listItem.innerHTML = `
             <div class="note-title">${note.title}</div>
             <div class="note-category">${note.category || 'Sem categoria'}</div>
         `;
         listItem.addEventListener('click', () => showNoteDetails(note.id));
         listElement.appendChild(listItem);
       });

       updateNoteCounter();
       showSection('notes-list-container');
    }

    function showNoteDetails(noteId) {
        const note = allNotes.find(n => n.id == noteId);
        if (!note) {
            console.error("Anotação não encontrada:", noteId);
            return;
        }
        currentNoteId = note.id;

        document.getElementById('note-detail-title').textContent = note.title;
        document.getElementById('note-detail-category').textContent = note.category ? `Categoria: ${note.category}` : '';
        // Substitui o marcador '↳' por quebras de linha reais para exibição
        document.getElementById('note-detail-content').textContent = note.content.replace(/↳/g, '\n');

        // Atualiza a classe 'active' na lista
        document.querySelectorAll('.note-item').forEach(item => {
            item.classList.remove('active');
            if (item.dataset.id == note.id) {
                item.classList.add('active');
            }
        });

        showSection('note-detail-container');
    }

    // --- FUNÇÕES DE FORMULÁRIO ---
    function openAddNoteForm() {
        document.getElementById('form-note-id').value = '';
        document.getElementById('form-note-title').value = '';
        document.getElementById('form-note-category').value = '';
        document.getElementById('form-note-content').value = '';
        showSection('note-form-container');
    }

    function openEditNoteForm(noteId) {
        const note = allNotes.find(n => n.id == noteId);
        if (!note) {
            console.error("Anotação não encontrada para edição:", noteId);
            return;
        }
        document.getElementById('form-note-id').value = note.id;
        document.getElementById('form-note-title').value = note.title;
        document.getElementById('form-note-category').value = note.category || '';
        // Mostra o conteúdo com o marcador '↳' para edição
        document.getElementById('form-note-content').value = note.content;
        showSection('note-form-container');
    }

    function cancelForm() {
        if (currentNoteId && allNotes.some(n => n.id == currentNoteId)) {
            showNoteDetails(currentNoteId);
        } else if (filteredNotes.length > 0) {
            showNoteDetails(filteredNotes[0].id);
        } else {
            displayNotesList(); // Se não houver notas, mostra a lista vazia
        }
    }

    // --- FUNÇÕES DE FILTRO E BUSCA ---
    function filterNotes() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const categoryFilter = document.getElementById('categoryFilter').value;

        filteredNotes = allNotes.filter(note => {
            const matchesSearch = note.title.toLowerCase().includes(searchTerm) ||
                                  note.content.toLowerCase().includes(searchTerm) ||
                                  (note.category && note.category.toLowerCase().includes(searchTerm));
            const matchesCategory = categoryFilter === '' || note.category === categoryFilter;
            return matchesSearch && matchesCategory;
        });

        displayNotesList();
    }

    // --- FUNÇÕES DE COMUNICAÇÃO COM O BACKEND ---
    async function loadNotes() {
        if (!WEB_APP_URL) {
             displayErrorMessage("Erro: 'webAppUrl' não foi fornecido nos parâmetros da URL. Ex: ?webAppUrl=URL_DO_WEB_APP.");
             return;
        }
        try {
            showSection('loading-message');
            // Usar o Web App para leitura
            const response = await fetch(`${WEB_APP_URL}?action=read`, {
                method: 'GET',
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Erro ao carregar dados: ${response.status} - ${errorText}`);
            }

            const jsonData = await response.json();

            if (jsonData.error) {
                 displayErrorMessage(`Erro do servidor: ${jsonData.error}`);
                 return;
            }

            if (!Array.isArray(jsonData) || jsonData.length === 0) {
                 displayErrorMessage("Nenhuma anotação encontrada na planilha.");
                 return;
            }

            // Mapeia os dados do JSON para o formato esperado pelo frontend
            allNotes = jsonData.map(item => ({
                id: item['ID'] || item['id'] || '',
                title: item['Título'] || item['Titulo'] || item['title'] || 'Sem título',
                content: item['Conteúdo'] || item['Conteudo'] || item['content'] || '',
                category: item['Categoria'] || item['category'] || '',
                created: item['Data de Criação'] || item['Data de Criacao'] || item['created'] || '',
                modified: item['Data de Modificação'] || item['Data de Modificacao'] || item['modified'] || ''
            }));

            filteredNotes = [...allNotes];
            populateCategoryFilter();
            filterNotes(); // Aplica filtros iniciais (que estarão vazios)
            if (filteredNotes.length > 0) {
                showNoteDetails(filteredNotes[0].id);
            } else {
                 showSection(); // Mostra área principal vazia
                 document.getElementById('loading-message').textContent = "Nenhuma anotação disponível.";
                 document.getElementById('loading-message').style.display = 'block';
            }
            updateNoteCounter();

        } catch (error) {
            console.error("Erro ao carregar anotações:", error);
            displayErrorMessage(`Falha ao carregar anotações: ${error.message}`);
        }
    }

    async function saveNote() {
        if (!WEB_APP_URL) {
             alert("Erro: 'webAppUrl' não foi fornecido. Não é possível salvar.");
             return;
        }
        const form = document.getElementById('note-form');
        const id = document.getElementById('form-note-id').value;
        const title = document.getElementById('form-note-title').value.trim();
        const category = document.getElementById('form-note-category').value.trim();
        const content = document.getElementById('form-note-content').value;

        if (!title) {
            alert("O título é obrigatório.");
            return;
        }

        const noteData = {
            action: id ? 'update' : 'create',
            id: id,
            title: title,
            content: content,
            category: category
        };

        try {
            const formData = new FormData();
            Object.keys(noteData).forEach(key => formData.append(key, noteData[key]));

            const response = await fetch(WEB_APP_URL, {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Erro do servidor: ${response.status} - ${errorText}`);
            }

            const result = await response.json();
            if (result.error) {
                throw new Error(result.error);
            }
            console.log("Sucesso:", result);
            // Recarrega os dados após salvar
            await loadNotes();
            // Volta para a visualização de detalhes
            if (noteData.id) {
                // Se era edição
                showNoteDetails(noteData.id);
            } else {
                // Se era criação, tenta encontrar o novo ID
                const newNoteId = result.newId;
                if (newNoteId) {
                    showNoteDetails(newNoteId);
                } else {
                    if (filteredNotes.length > 0) {
                        showNoteDetails(filteredNotes[0].id);
                    } else {
                        showSection(); // Mostra área principal vazia
                         document.getElementById('loading-message').textContent = "Nenhuma anotação disponível.";
                         document.getElementById('loading-message').style.display = 'block';
                    }
                }
            }

        } catch (error) {
            console.error("Erro ao salvar anotação:", error);
            alert(`Erro ao salvar: ${error.message}`);
        }
    }

    async function deleteNote(noteId) {
        if (!WEB_APP_URL) {
             alert("Erro: 'webAppUrl' não foi fornecido. Não é possível excluir.");
             return;
        }
        if (!confirm("Tem certeza que deseja excluir esta anotação?")) {
            return;
        }

        try {
            const formData = new FormData();
            formData.append('action', 'delete');
            formData.append('id', noteId);

            const response = await fetch(WEB_APP_URL, {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Erro do servidor: ${response.status} - ${errorText}`);
            }

            const result = await response.json();
            if (result.error) {
                 throw new Error(result.error);
            }
            console.log("Excluído com sucesso:", result);
            // Recarrega os dados após excluir
            await loadNotes();
            // Seleciona outra anotação ou limpa os detalhes
            if (filteredNotes.length > 0) {
                showNoteDetails(filteredNotes[0].id);
            } else {
                currentNoteId = null;
                showSection(); // Mostra área principal vazia
                 document.getElementById('loading-message').textContent = "Nenhuma anotação disponível.";
                 document.getElementById('loading-message').style.display = 'block';
            }

        } catch (error) {
            console.error("Erro ao excluir anotação:", error);
            alert(`Erro ao excluir: ${error.message}`);
        }
    }

    // --- INICIALIZAÇÃO ---
    document.getElementById('note-form').addEventListener('submit', function(e) {
        e.preventDefault();
        saveNote();
    });

    // Inicia o carregamento das anotações quando a página é carregada
    window.addEventListener('load', loadNotes);

    // Tooltip simples para os botões da barra inferior (se houver)
    function showTooltipOnHover(el) {
      clearTimeout(el.tooltipTimer);
      el.classList.add("show-tooltip");
      el.tooltipTimer = setTimeout(() => {
        el.classList.remove("show-tooltip");
      }, 1000);
    }
    function hideTooltipOnLeave(el) {
      clearTimeout(el.tooltipTimer);
      el.classList.remove("show-tooltip");
    }
  </script>
</body>
</html>
