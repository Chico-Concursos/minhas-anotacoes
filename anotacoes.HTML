<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Anotações - Container Ampliado</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
      color: #333;
      min-height: 100vh;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .container {
      max-width: 1400px; /* Aumentado para acomodar o conteúdo expandido */
      width: 100%;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }
    
    header {
      text-align: center;
      padding: 15px 0;
      color: white;
    }
    
    header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .app-container {
      margin-top: 15px;
    }
    
    .notes-app {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.25);
      min-height: 600px;
    }
    
    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #eee;
      flex-wrap: wrap;
    }
    
    .app-header h2 {
      color: #1a2a6c;
      font-size: 1.8rem;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #f0f7ff;
      padding: 8px 15px;
      border-radius: 50px;
      font-weight: 500;
    }
    
    .top-bar {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    
    .top-bar button {
      background: linear-gradient(to right, #1a2a6c, #b21f1f);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 50px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: bold;
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
      font-size: 1.05rem;
      transition: transform 0.3s, box-shadow 0.3s;
    }
    
    .top-bar button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.2);
    }
    
    .top-bar input[type="text"] {
      flex: 1;
      padding: 12px 20px;
      border: 2px solid #ddd;
      border-radius: 50px;
      font-size: 1.05rem;
      min-width: 250px;
      transition: border-color 0.3s;
    }
    
    .top-bar input[type="text"]:focus {
      border-color: #1a2a6c;
      outline: none;
    }
    
    .top-bar select {
      padding: 12px 20px;
      border: 2px solid #ddd;
      border-radius: 50px;
      background: white;
      font-size: 1.05rem;
      min-width: 180px;
      transition: border-color 0.3s;
    }
    
    .top-bar select:focus {
      border-color: #1a2a6c;
      outline: none;
    }
    
    .note-counter {
      background: #1a2a6c;
      color: white;
      padding: 10px 20px;
      border-radius: 50px;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 1.1rem;
    }
    
    #main-container {
      display: flex;
      height: 550px;
      gap: 25px;
    }
    
    #notes-list-container {
      flex: 1;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transition: transform 0.3s;
      min-width: 300px;
      max-width: 400px;
    }
    
    .list-header {
      background: #1a2a6c;
      color: white;
      padding: 18px;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      font-size: 1.1rem;
    }
    
    #notes-list {
      flex: 1;
      overflow-y: auto;
      list-style: none;
      background: #f9f9f9;
    }
    
    .note-item {
      padding: 18px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .note-item:hover {
      background: #f0f7ff;
    }
    
    .note-item.active {
      background: #e3f2fd;
      border-left: 5px solid #1a2a6c;
    }
    
    .note-title {
      font-weight: bold;
      margin-bottom: 8px;
      color: #1a2a6c;
      font-size: 1.1rem;
    }
    
    .note-category {
      background: #e0e0e0;
      display: inline-block;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      color: #555;
      font-weight: 500;
    }
    
    #note-detail-container {
      flex: 3; /* Aumentado para ocupar mais espaço */
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      padding: 25px;
      display: flex;
      flex-direction: column;
      background: white;
      transition: transform 0.3s;
      position: relative;
    }
    
    #note-detail-title {
      font-size: 1.9rem;
      font-weight: bold;
      margin-bottom: 15px;
      color: #1a2a6c;
      padding-bottom: 15px;
      border-bottom: 2px solid #eee;
    }
    
    #note-detail-category {
      font-size: 1rem;
      color: #b21f1f;
      margin-bottom: 18px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
    }
    
    #note-detail-content {
      flex: 1;
      white-space: pre-wrap;
      line-height: 1.7;
      padding: 15px;
      font-size: 1.05rem;
      color: #444;
      max-height: calc(100% - 150px);
      border: 1px solid #eee;
      border-radius: 8px;
      margin-bottom: 15px;
      
      /* Controle de conteúdo longo */
      width: 100%;
      max-width: 100%;
      overflow-x: auto;
      overflow-y: auto;
      word-break: break-word;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      background-color: #fff;
      
      /* Container com rolagem interna */
      display: block;
      position: relative;
    }
    
    /* Controles para redimensionar */
    .resize-handle {
      position: absolute;
      right: 5px;
      top: 5px;
      background: #1a2a6c;
      color: white;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 10;
      transition: all 0.3s;
    }
    
    .resize-handle:hover {
      transform: scale(1.1);
      background: #b21f1f;
    }
    
    .note-actions {
      display: flex;
      gap: 15px;
      padding-top: 20px;
      border-top: 2px solid #eee;
      margin-top: auto;
    }
    
    .note-actions button {
      padding: 12px 25px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.05rem;
      transition: transform 0.3s, opacity 0.3s;
    }
    
    .note-actions button:hover {
      transform: translateY(-2px);
      opacity: 0.9;
    }
    
    .btn-edit {
      background: #1a2a6c;
      color: white;
    }
    
    .btn-delete {
      background: #b21f1f;
      color: white;
    }
    
    #note-form-container {
      display: none;
      flex-direction: column;
      height: 100%;
      flex: 3; /* Aumentado para ocupar mais espaço */
    }
    
    #note-form {
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    
    #note-form input, #note-form textarea {
      padding: 15px;
      margin-bottom: 20px;
      border: 2px solid #ddd;
      border-radius: 10px;
      font-size: 1.05rem;
      transition: border-color 0.3s;
    }
    
    #note-form input:focus, #note-form textarea:focus {
      border-color: #1a2a6c;
      outline: none;
    }
    
    #note-form textarea {
      flex: 1;
      resize: vertical;
      min-height: 300px;
      max-width: 100%;
      overflow-wrap: break-word;
    }
    
    .form-actions {
      display: flex;
      gap: 15px;
      margin-top: 10px;
    }
    
    .form-actions button {
      padding: 14px 30px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      font-size: 1.1rem;
      transition: transform 0.3s, opacity 0.3s;
    }
    
    .form-actions button:hover {
      transform: translateY(-2px);
      opacity: 0.9;
    }
    
    .btn-save {
      background: #4CAF50;
      color: white;
    }
    
    .btn-cancel {
      background: #757575;
      color: white;
    }
    
    #login-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px;
      text-align: center;
      height: 100%;
    }
    
    #login-form {
      background: white;
      padding: 40px;
      border-radius: 15px;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    
    #login-form h2 {
      color: #1a2a6c;
      margin-bottom: 25px;
    }
    
    #login-form input {
      width: 100%;
      padding: 15px;
      margin-bottom: 20px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 1.05rem;
      transition: border-color 0.3s;
    }
    
    #login-form input:focus {
      border-color: #1a2a6c;
      outline: none;
    }
    
    #login-form button {
      background: linear-gradient(to right, #1a2a6c, #b21f1f);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 8px;
      font-size: 1.1rem;
      cursor: pointer;
      font-weight: bold;
      width: 100%;
      transition: transform 0.3s, opacity 0.3s;
    }
    
    #login-form button:hover {
      transform: translateY(-2px);
      opacity: 0.9;
    }
    
    #loading-message, #error-message {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100%;
      font-size: 1.3rem;
      flex-direction: column;
      gap: 25px;
      text-align: center;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 12px;
      padding: 30px;
    }
    
    #loading-message i {
      font-size: 3.5rem;
      color: #1a2a6c;
      animation: spin 1.5s linear infinite;
    }
    
    #error-message {
      color: #b21f1f;
    }
    
    /* Sistema de Notificação */
    .notification-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      max-width: 350px;
      width: 100%;
    }
    
    .notification {
      background: white;
      border-radius: 8px;
      padding: 15px 20px;
      margin-bottom: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      gap: 15px;
      animation: slideIn 0.3s ease, fadeOut 0.3s ease 4.7s forwards;
      border-left: 5px solid #4CAF50;
      transition: transform 0.3s;
    }
    
    .notification:hover {
      transform: translateY(-3px);
    }
    
    .notification.error {
      border-left-color: #f44336;
    }
    
    .notification-icon {
      font-size: 1.8rem;
    }
    
    .success .notification-icon {
      color: #4CAF50;
    }
    
    .error .notification-icon {
      color: #f44336;
    }
    
    .notification-content {
      flex: 1;
    }
    
    .notification-title {
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .notification-close {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.2rem;
      color: #777;
      transition: color 0.3s;
    }
    
    .notification-close:hover {
      color: #333;
    }
    
    /* Modal de Confirmação */
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 999;
      display: none;
    }
    
    .modal {
      background: white;
      border-radius: 12px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 15px 35px rgba(0,0,0,0.3);
      transform: translateY(-20px);
      animation: modalAppear 0.4s ease forwards;
    }
    
    .modal h3 {
      margin-bottom: 20px;
      color: #1a2a6c;
      font-size: 1.5rem;
    }
    
    .modal p {
      margin-bottom: 25px;
      font-size: 1.1rem;
      line-height: 1.6;
    }
    
    .modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 15px;
    }
    
    .modal-buttons button {
      padding: 12px 25px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      font-size: 1rem;
      transition: transform 0.3s, opacity 0.3s;
    }
    
    .modal-buttons button:hover {
      transform: translateY(-2px);
      opacity: 0.9;
    }
    
    .btn-modal-confirm {
      background: #4CAF50;
      color: white;
    }
    
    .btn-modal-cancel {
      background: #f44336;
      color: white;
    }
    
    /* Estilo para o identificador da página */
    .page-identifier {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      padding: 12px 20px;
      margin-top: 15px;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      font-size: 1.1rem;
      backdrop-filter: blur(5px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      width: 100%;
    }
    
    .page-identifier i {
      color: #ffcc00;
    }
    
    .debug-info {
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
      font-size: 0.9rem;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .debug-info h4 {
      margin-bottom: 10px;
      color: #ffcc00;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .debug-toggle {
      background: #1a2a6c;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 10px;
    }
    
    /* Botão de logout */
    .logout-button {
      background: none;
      border: none;
      cursor: pointer;
      color: #1a2a6c;
      font-size: 1.2rem;
      margin-left: 10px;
      transition: color 0.3s;
    }
    
    .logout-button:hover {
      color: #b21f1f;
    }
    
    /* Animações */
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
    
    @keyframes modalAppear {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Responsivo */
    @media (max-width: 900px) {
      #main-container {
        flex-direction: column;
        height: auto;
        min-height: 850px;
      }
      
      header h1 {
        font-size: 2rem;
      }
      
      .top-bar {
        flex-direction: column;
      }
      
      .top-bar input[type="text"], 
      .top-bar select {
        width: 100%;
      }
      
      .app-header {
        flex-direction: column;
        gap: 15px;
      }
      
      .notes-app {
        padding: 20px;
      }
      
      #notes-list-container {
        min-width: unset;
        max-width: unset;
      }
      
      #note-detail-content {
        max-width: 100%;
        overflow-x: auto;
      }
    }
    
    @media (max-width: 600px) {
      body {
        padding: 10px;
      }
      
      .container {
        padding: 15px;
      }
      
      .page-identifier {
        font-size: 0.9rem;
        padding: 8px 15px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1><i class="fas fa-book"></i> Sistema de Anotações</h1>
      <p>Acesse com seu e-mail para ver suas anotações</p>
    </header>
    
    <div class="app-container">
      <div class="notes-app">
        <div id="login-container" style="display: flex;">
          <form id="login-form">
            <h2><i class="fas fa-lock"></i> Acesso</h2>
            <p>Insira seu e-mail para acessar suas anotações:</p>
            <input type="email" id="user-email" placeholder="Seu e-mail" required>
            <button type="button" onclick="login()">
              <i class="fas fa-sign-in-alt"></i> Acessar
            </button>
          </form>
        </div>
        
        <div id="app-content" style="display: none;">
          <div class="app-header">
            <h2><i class="fas fa-sticky-note"></i> Minhas Anotações</h2>
            <div class="user-info">
              <i class="fas fa-user-circle"></i>
              <span id="user-email-display">usuario@exemplo.com</span>
              <!-- Botão de logout -->
              <button class="logout-button" onclick="logout()" title="Sair">
                <i class="fas fa-sign-out-alt"></i>
              </button>
            </div>
          </div>
          
          <div class="top-bar">
            <button onclick="openAddNoteForm()">
              <i class="fas fa-plus"></i> Nova Anotação
            </button>
            <input type="text" id="searchInput" placeholder="Buscar..." oninput="filterNotes()">
            <select id="categoryFilter" onchange="filterNotes()">
              <option value="">Todas as Categorias</option>
            </select>
          </div>
          
          <div id="main-container">
            <div id="loading-message">
              <i class="fas fa-spinner"></i>
              <p>Carregando anotações...</p>
            </div>
            
            <div id="error-message" style="display:none;"></div>
            
            <div id="notes-list-container" style="display:none;">
              <div class="list-header">
                <span>Suas Anotações</span>
                <span id="filtered-counter">0/0</span>
              </div>
              <ul id="notes-list"></ul>
            </div>
            
            <div id="note-detail-container" style="display:none;">
              <!-- Botão para expandir -->
              <div class="resize-handle" title="Expandir/Contrair" onclick="toggleContainerSize()">
                <i class="fas fa-expand"></i>
              </div>
              
              <div id="note-detail-title">Título da Anotação</div>
              <div id="note-detail-category">
                <i class="fas fa-tag"></i>
                <span>Categoria</span>
              </div>
              <div id="note-detail-content">
                Conteúdo da anotação será exibido aqui. O container agora está significativamente maior no sentido horizontal, permitindo melhor visualização do conteúdo.

                Exemplo de conteúdo longo:
                Este é um exemplo de texto que se estende horizontalmente para demonstrar como o container ampliado acomoda melhor o conteúdo: Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.
                
                Com o aumento de espaço:
                - Melhor visualização de tabelas
                - Facilidade para trabalhar com código
                - Texto mais confortável para leitura
                - Melhor organização do conteúdo
              </div>
              <div class="note-actions">
                <button class="btn-edit" onclick="openEditNoteForm(currentNoteId)">
                  <i class="fas fa-edit"></i> Editar
                </button>
                <button class="btn-delete" onclick="deleteNote(currentNoteId)">
                  <i class="fas fa-trash"></i> Excluir
                </button>
              </div>
            </div>
            
            <div id="note-form-container">
              <form id="note-form">
                <input type="hidden" id="form-note-id" value="">
                <input type="text" id="form-note-title" placeholder="Título" required>
                <input type="text" id="form-note-category" placeholder="Categoria">
                <textarea id="form-note-content" placeholder="Conteúdo"></textarea>
                <div class="form-actions">
                  <button class="btn-save" type="submit">
                    <i class="fas fa-save"></i> Salvar
                  </button>
                  <button class="btn-cancel" type="button" onclick="cancelForm()">
                    <i class="fas fa-times"></i> Cancelar
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Identificador da página do Google Sites (na parte inferior) -->
    <div class="page-identifier">
      <i class="fas fa-link"></i>
      <span id="page-identifier-display">Vinculado à página: Carregando...</span>
    </div>
    
    <!-- Área de depuração -->
    <div class="debug-info" id="debug-info" style="display: none;">
      <h4><i class="fas fa-bug"></i> Informações de Depuração</h4>
      <div id="debug-content"></div>
    </div>
    
    <button class="debug-toggle" onclick="toggleDebug()">
      <i class="fas fa-code"></i> Mostrar/Ocultar Depuração
    </button>
  </div>

  <!-- Sistema de Notificação -->
  <div class="notification-container" id="notification-container"></div>
  
  <!-- Modal de Confirmação -->
  <div class="modal-backdrop" id="confirmModal">
    <div class="modal">
      <h3>Confirmação</h3>
      <p id="confirmMessage">Tem certeza que deseja excluir esta anotação?</p>
      <div class="modal-buttons">
        <button class="btn-modal-cancel" onclick="closeModal(false)">Cancelar</button>
        <button class="btn-modal-confirm" onclick="closeModal(true)">Confirmar</button>
      </div>
    </div>
  </div>

  <script>
    // --- CONFIGURAÇÃO INICIAL ---
    let WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyeWFpisAExqCY5FscF_tF5c_WUWavp3Y-8MPkgPhL3Mj0RoDikM4432hmnDhc-g79Y/exec";
    
    // --- VARIÁVEIS GLOBAIS ---
    let allNotes = [];
    let filteredNotes = [];
    let currentNoteId = null;
    let userEmail = null;
    let deleteCallback = null;
    let googleSitesPageId = '';
    let isContainerExpanded = false;
    
    // --- INICIALIZAÇÃO ---
    document.addEventListener("DOMContentLoaded", function() {
      // Tenta obter o ID da página do Google Sites e a URL do App Script
      getParametersFromURL();
      
      // Configura os event listeners
      const noteForm = document.getElementById("note-form");
      if (noteForm) {
        noteForm.addEventListener("submit", function(e) {
          e.preventDefault();
          saveNote();
        });
      }
      
      const loginForm = document.getElementById("login-form");
      if (loginForm) {
        loginForm.addEventListener("submit", function(e) {
          e.preventDefault();
          login();
        });
      }

      // Verifica se há email salvo no localStorage
      const savedEmail = localStorage.getItem('userEmail');
      if (savedEmail) {
        userEmail = savedEmail;
        document.getElementById('user-email-display').textContent = savedEmail;
        document.getElementById('login-container').style.display = 'none';
        document.getElementById('app-content').style.display = 'block';
        loadNotes();
      }
      
      // Mostra o link atual para depuração
      logDebug(`URL Atual: ${window.location.href}`);
    });
    
    // Função para alternar o tamanho do container
    function toggleContainerSize() {
      const container = document.getElementById("note-detail-container");
      const formContainer = document.getElementById("note-form-container");
      
      isContainerExpanded = !isContainerExpanded;
      
      if (isContainerExpanded) {
        container.style.flex = "5";
        formContainer.style.flex = "5";
        document.querySelector('.resize-handle i').className = 'fas fa-compress';
        document.querySelector('.resize-handle').title = "Contrair";
      } else {
        container.style.flex = "3";
        formContainer.style.flex = "3";
        document.querySelector('.resize-handle i').className = 'fas fa-expand';
        document.querySelector('.resize-handle').title = "Expandir";
      }
      
      showNotification(`Container ${isContainerExpanded ? 'expandido' : 'contraído'}`, 'success');
    }
    
    // Função para obter parâmetros da URL
    function getParametersFromURL() {
      try {
        const urlParams = new URLSearchParams(window.location.search);
        
        // Obtém a URL do Web App (se fornecida)
        const customWebAppUrl = urlParams.get('webAppUrl');
        if (customWebAppUrl) {
          WEB_APP_URL = customWebAppUrl;
          logDebug(`Usando WEB_APP_URL: ${WEB_APP_URL}`);
        }
        
        // Obtém o ID da página do Google Sites
        googleSitesPageId = urlParams.get('googleSitesPageId') || '';
        logDebug(`googleSitesPageId: ${googleSitesPageId}`);
        
        // Remove espaços e caracteres especiais
        googleSitesPageId = googleSitesPageId.replace(/[^a-zA-Z0-9-_]/g, '');
        logDebug(`googleSitesPageId sanitizado: ${googleSitesPageId}`);
        
        // Atualiza o display
        document.getElementById('page-identifier-display').textContent = 
          `Vinculado à página: ${googleSitesPageId || 'Não identificada'}`;
          
      } catch (e) {
        console.error("Erro ao obter parâmetros da URL:", e);
        logDebug(`Erro ao obter parâmetros: ${e.message}`);
        document.getElementById('page-identifier-display').textContent = 
          "Vinculado à página: Não identificada";
      }
    }
    
    // Funções de depuração
    function logDebug(message) {
      const debugContent = document.getElementById('debug-content');
      if (debugContent) {
        const p = document.createElement('p');
        p.textContent = `[DEBUG] ${new Date().toLocaleTimeString()}: ${message}`;
        debugContent.appendChild(p);
      }
      console.debug(message);
    }
    
    function toggleDebug() {
      const debugInfo = document.getElementById('debug-info');
      debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
    }
    
    // --- SISTEMA DE NOTIFICAÇÃO ---
    function showNotification(message, type = 'success') {
      const container = document.getElementById('notification-container');
      
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.innerHTML = `
        <div class="notification-icon ${type}">
          <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle'}"></i>
        </div>
        <div class="notification-content">
          <div class="notification-title">${type === 'success' ? 'Sucesso!' : 'Erro!'}</div>
          <div class="notification-text">${message}</div>
        </div>
        <button class="notification-close" onclick="this.parentElement.remove()">
          <i class="fas fa-times"></i>
        </button>
      `;
      
      container.appendChild(notification);
      
      // Remove automaticamente após 5 segundos
      setTimeout(() => {
        if (notification.parentNode) {
          notification.remove();
        }
      }, 5000);
      
      logDebug(`Notificação: ${type} - ${message}`);
    }
    
    // --- MODAL DE CONFIRMAÇÃO ---
    function showConfirm(message, callback) {
      document.getElementById('confirmMessage').textContent = message;
      document.getElementById('confirmModal').style.display = 'flex';
      deleteCallback = callback;
    }
    
    function closeModal(confirmed) {
      document.getElementById('confirmModal').style.display = 'none';
      if (deleteCallback) {
        deleteCallback(confirmed);
        deleteCallback = null;
      }
    }
    
    // --- FUNÇÕES DE INTERFACE ---
    function showSection(sectionId) {
      const sections = [
        "notes-list-container",
        "note-detail-container",
        "note-form-container",
        "loading-message",
        "error-message"
      ];
      
      sections.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = 'none';
      });
      
      if (sectionId && document.getElementById(sectionId)) {
        document.getElementById(sectionId).style.display = 'block';
      }
    }

    function updateNoteCounter() {
      const filteredCounter = document.getElementById("filtered-counter");
      if (filteredCounter) {
        filteredCounter.textContent = `${filteredNotes.length}/${allNotes.length}`;
      }
    }
    
    function populateCategoryFilter() {
      const filterSelect = document.getElementById("categoryFilter");
      if (filterSelect) {
        filterSelect.innerHTML = "<option value=\"\">Todas as Categorias</option>";
        
        const categories = [...new Set(allNotes.map(note => note.category).filter(cat => cat))];
        
        categories.forEach(category => {
          const option = document.createElement("option");
          option.value = category;
          option.textContent = category;
          filterSelect.appendChild(option);
        });
      }
    }

    // --- FUNÇÕES DE EXIBIÇÃO DE DADOS ---
    function displayNotesList() {
      const listElement = document.getElementById("notes-list");
      if (listElement) {
        listElement.innerHTML = "";

        filteredNotes.forEach(note => {
          const listItem = document.createElement("li");
          listItem.className = "note-item";
          if (note.id === currentNoteId) {
              listItem.classList.add("active");
          }
          listItem.dataset.id = note.id;
          listItem.innerHTML = `
              <div class="note-title">${note.title || "Sem título"}</div>
              <div class="note-category">${note.category ? note.category : "Sem categoria"}</div>
          `;
          listItem.addEventListener("click", () => showNoteDetails(note.id));
          listElement.appendChild(listItem);
        });

        updateNoteCounter();
        showSection("notes-list-container");
      }
    }

    function showNoteDetails(noteId) {
      const note = allNotes.find(n => n.id == noteId);
      if (!note) return;
      
      currentNoteId = note.id;

      if (document.getElementById("note-detail-title")) {
        document.getElementById("note-detail-title").textContent = note.title || "Sem título";
      }
      
      const categoryElement = document.getElementById("note-detail-category");
      if (categoryElement) {
        categoryElement.innerHTML = note.category ? 
          `<i class="fas fa-tag"></i> ${note.category}` : 
          "";
      }
      
      if (document.getElementById("note-detail-content")) {
        document.getElementById("note-detail-content").textContent = note.content || "";
      }

      document.querySelectorAll(".note-item").forEach(item => {
        item.classList.remove("active");
        if (item.dataset.id == note.id) {
          item.classList.add("active");
        }
      });

      showSection("note-detail-container");
    }

    // --- FUNÇÕES DE FORMULÁRIO ---
    function openAddNoteForm() {
      document.getElementById("form-note-id").value = "";
      document.getElementById("form-note-title").value = "";
      document.getElementById("form-note-category").value = "";
      document.getElementById("form-note-content").value = "";
      
      showSection("note-form-container");
      
      setTimeout(() => {
        document.getElementById("form-note-title").focus();
      }, 100);
    }

    function openEditNoteForm(noteId) {
      const note = allNotes.find(n => n.id == noteId);
      if (!note) return;
      
      document.getElementById("form-note-id").value = note.id;
      document.getElementById("form-note-title").value = note.title || "";
      document.getElementById("form-note-category").value = note.category || "";
      document.getElementById("form-note-content").value = note.content || "";
      
      showSection("note-form-container");
      setTimeout(() => {
        document.getElementById("form-note-title").focus();
      }, 100);
    }

    function cancelForm() {
      if (currentNoteId) {
        showNoteDetails(currentNoteId);
      } else if (filteredNotes.length > 0) {
        showNoteDetails(filteredNotes[0].id);
      } else {
        displayNotesList();
      }
    }

    // --- FUNÇÕES DE FILTRO E BUSCA ---
    function filterNotes() {
      const searchTerm = document.getElementById("searchInput").value.toLowerCase();
      const categoryFilter = document.getElementById("categoryFilter").value;

      filteredNotes = allNotes.filter(note => {
        const matchesSearch = 
          (note.title && note.title.toLowerCase().includes(searchTerm)) ||
          (note.content && note.content.toLowerCase().includes(searchTerm)) ||
          (note.category && note.category.toLowerCase().includes(searchTerm));
        
        const matchesCategory = categoryFilter === "" || note.category === categoryFilter;
        
        return matchesSearch && matchesCategory;
      });

      displayNotesList();
      
      if (filteredNotes.length > 0 && !currentNoteId) {
        showNoteDetails(filteredNotes[0].id);
      }
    }

    // --- FUNÇÕES DE AUTENTICAÇÃO ---
    function login() {
      const emailInput = document.getElementById('user-email');
      if (emailInput) {
        const email = emailInput.value.trim();
        if (email) {
          userEmail = email;
          localStorage.setItem('userEmail', email);
          
          document.getElementById('user-email-display').textContent = email;
          document.getElementById('login-container').style.display = 'none';
          document.getElementById('app-content').style.display = 'block';
          
          loadNotes();
        } else {
          showNotification('Por favor, insira um e-mail válido.', 'error');
        }
      }
    }
    
    // Função de logout
    function logout() {
      localStorage.removeItem('userEmail');
      userEmail = null;
      document.getElementById('login-container').style.display = 'flex';
      document.getElementById('app-content').style.display = 'none';
      showNotification('Você saiu da conta.', 'success');
    }

    // --- FUNÇÕES DE COMUNICAÇÃO COM O BACKEND ---
    async function loadNotes() {
      if (!userEmail) return;
      if (!googleSitesPageId) {
        showNotification('ID da página não identificado. As anotações não serão carregadas.', 'error');
        return;
      }
      
      try {
        showSection("loading-message");
        
        // URL com parâmetros de depuração
        const url = new URL(WEB_APP_URL);
        url.searchParams.append('action', 'read');
        url.searchParams.append('userEmail', userEmail);
        url.searchParams.append('pageId', googleSitesPageId);
        url.searchParams.append('debug', 'true');
        
        logDebug(`Carregando anotações de: ${url.toString()}`);
        
        const response = await fetch(url, {
          redirect: 'follow'
        });
        
        logDebug(`Resposta recebida. Status: ${response.status}`);
        
        if (!response.ok) {
          throw new Error(`Erro ${response.status}`);
        }
        
        const result = await response.json();
        logDebug(`Dados recebidos: ${JSON.stringify(result).substring(0, 200)}...`);
        
        // Verifica se o resultado é um array
        if (!Array.isArray(result)) {
          throw new Error('Resposta do servidor inválida');
        }
        
        allNotes = result.map(item => ({
          id: item["ID"] || "",
          title: item["Título"] || "Sem título",
          content: item["Conteúdo"] || "",
          category: item["Categoria"] || "",
          created: item["Data de Criação"] || ""
        }));
        
        logDebug(`Total de anotações carregadas: ${allNotes.length}`);
        
        filteredNotes = [...allNotes];
        populateCategoryFilter();
        
        if (filteredNotes.length > 0) {
          showNoteDetails(filteredNotes[0].id);
        } else {
          showSection("notes-list-container");
        }
        
        updateNoteCounter();
        
      } catch (error) {
        console.error("Erro ao carregar anotações:", error);
        logDebug(`Erro ao carregar anotações: ${error.message}`);
        showNotification(`Falha ao carregar anotações: ${error.message}`, 'error');
      }
    }

    async function saveNote() {
      if (!userEmail) {
        showNotification('Usuário não autenticado.', 'error');
        return;
      }
      
      if (!googleSitesPageId) {
        showNotification('ID da página não identificado. A anotação não será salva.', 'error');
        return;
      }
      
      const title = document.getElementById("form-note-title").value.trim();
      const category = document.getElementById("form-note-category").value.trim();
      const content = document.getElementById("form-note-content").value;
      const noteId = document.getElementById("form-note-id").value;

      if (!title) {
        showNotification('O título é obrigatório.', 'error');
        document.getElementById("form-note-title").focus();
        return;
      }

      try {
        const url = new URL(WEB_APP_URL);
        const params = new URLSearchParams();
        params.append("action", noteId ? "update" : "create");
        if (noteId) params.append("id", noteId);
        params.append("title", title);
        params.append("content", content);
        params.append("category", category);
        params.append("userEmail", userEmail);
        params.append("pageId", googleSitesPageId);
        params.append("debug", "true");
        
        logDebug(`Enviando para: ${url.toString()}`);
        logDebug(`Parâmetros: ${params.toString()}`);
        
        const response = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: params,
          redirect: 'follow'
        });
        
        logDebug(`Resposta recebida. Status: ${response.status}`);
        
        const result = await response.json();
        logDebug(`Resultado: ${JSON.stringify(result)}`);
        
        if (result.error) {
          throw new Error(result.error);
        }
        
        if (!result.success) {
          throw new Error(result.message);
        }
        
        showNotification('Operação realizada com sucesso!');
        await loadNotes();
        
      } catch (error) {
        console.error("Erro ao salvar anotação:", error);
        logDebug(`Erro ao salvar: ${error.message}`);
        showNotification(`Erro ao salvar: ${error.message}`, 'error');
      }
    }

    async function deleteNote(noteId) {
      if (!userEmail) {
        showNotification('Usuário não autenticado.', 'error');
        return;
      }
      
      if (!googleSitesPageId) {
        showNotification('ID da página não identificado. A anotação não será excluída.', 'error');
        return;
      }
      
      if (!noteId) {
        showNotification('ID da anotação não encontrado.', 'error');
        return;
      }

      showConfirm('Tem certeza que deseja excluir esta anotação?', async (confirmed) => {
        if (confirmed) {
          try {
            const url = new URL(WEB_APP_URL);
            const params = new URLSearchParams();
            params.append("action", "delete");
            params.append("id", noteId);
            params.append("userEmail", userEmail);
            params.append("pageId", googleSitesPageId);
            params.append("debug", "true");
            
            logDebug(`Enviando para: ${url.toString()}`);
            logDebug(`Parâmetros: ${params.toString()}`);
            
            const response = await fetch(url, {
              method: "POST",
              headers: { "Content-Type": "application/x-www-form-urlencoded" },
              body: params,
              redirect: 'follow'
            });
            
            logDebug(`Resposta recebida. Status: ${response.status}`);
            
            const result = await response.json();
            logDebug(`Resultado: ${JSON.stringify(result)}`);
            
            if (result.error) {
              throw new Error(result.error);
            }
            
            if (!result.success) {
              throw new Error(result.message);
            }
            
            showNotification('Anotação excluída com sucesso!');
            await loadNotes();
            
          } catch (error) {
            console.error("Erro ao excluir anotação:", error);
            logDebug(`Erro ao excluir: ${error.message}`);
            showNotification(`Erro ao excluir: ${error.message}`, 'error');
          }
        }
      });
    }
  </script>
</body>
</html>
