<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Minhas Anotações</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      background-color: black;
      color: #FFD700;
      font-family: Arial, sans-serif;
      text-align: center;
    }
    .top-bar {
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: #111;
      padding: 10px;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 5px;
    }
    .top-bar button,
    .top-bar select,
    .top-bar input {
      background: none;
      border: none;
      color: white;
      font-size: 1.0em;
      cursor: pointer;
      position: relative;
    }
    .top-bar input[type="text"] {
      border: 1px solid #555;
      border-radius: 4px;
      padding: 2px 5px;
      background-color: #222;
    }
    .top-bar span {
      font-size: 1.0em;
      color: white;
    }
    .top-bar select {
      background-color: #222;
      border: 1px solid #555;
      padding: 2px 4px;
    }
    /* Tooltip para botões do topo */
    .tooltip:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      top: 120%;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: #fff;
      padding: 5px 8px;
      border-radius: 4px;
      white-space: nowrap;
      font-size: 0.8em;
      z-index: 10;
    }
    #main-container {
      background-color: white;
      color: black;
      width: 96%;
      height: 70vh;
      margin: 20px auto;
      margin-top: 3px;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
      display: flex;
      overflow: hidden;
    }
    #notes-list-container {
      width: 30%;
      border-right: 1px solid #ccc;
      overflow-y: auto;
      padding-right: 10px;
    }
    #notes-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .note-item {
      padding: 10px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      text-align: left;
    }
    .note-item:hover {
      background-color: #f0f0f0;
    }
    .note-item.active {
      background-color: #e0e0e0;
      font-weight: bold;
    }
    .note-title {
      font-weight: bold;
      margin-bottom: 5px;
    }
    .note-category {
      font-size: 0.8em;
      color: #666;
    }
    #note-detail-container {
      width: 70%;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    #note-detail-content {
      flex-grow: 1;
      white-space: pre-wrap;
      text-align: left;
      margin-bottom: 20px;
    }
    #note-detail-title {
      font-size: 1.5em;
      font-weight: bold;
      margin-bottom: 10px;
    }
    #note-detail-category {
      font-size: 0.9em;
      color: #888;
      margin-bottom: 15px;
    }
    #note-form-container {
      display: none;
      width: 100%;
      padding: 20px;
      overflow-y: auto;
    }
    #note-form {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      width: 100%;
    }
    #note-form input[type="text"],
    #note-form textarea {
      width: 100%;
      padding: 8px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-family: Arial, sans-serif;
    }
    #note-form textarea {
      height: 200px;
      resize: vertical;
    }
    #note-form button {
      background-color: gold;
      color: black;
      border: none;
      padding: 10px 20px;
      margin: 5px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1em;
    }
    #note-form button:hover {
      background-color: #e5c300;
    }
    .bottom-bar {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 20px 0;
      flex-wrap: wrap;
      gap: 10px;
    }
    .bottom-bar button {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.4em;
      color: white;
      position: relative;
    }
    .bottom-bar button::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 120%;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: #fff;
      padding: 4px 6px;
      border-radius: 4px;
      font-size: 0.75em;
      white-space: nowrap;
      z-index: 10;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    .bottom-bar button.show-tooltip::after {
      opacity: 1;
    }
    #loading-message {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100%;
      font-size: 1.2em;
    }
    #error-message {
      color: red;
      font-weight: bold;
      padding: 20px;
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <button class="tooltip" data-tooltip="Nova Anotação" onclick="openAddNoteForm()">➕</button>
    <input type="text" id="searchInput" placeholder="Buscar..." oninput="filterNotes()" />
    <select id="categoryFilter" onchange="filterNotes()">
      <option value="">Todas as Categorias</option>
    </select>
    <span id="noteCounter">0 anotações</span>
  </div>

  <div id="main-container">
    <div id="loading-message">Carregando anotações...</div>
    <div id="error-message" style="display:none;"></div>

    <!-- Área de Listagem -->
    <div id="notes-list-container" style="display:none;">
      <ul id="notes-list"></ul>
    </div>

    <!-- Área de Detalhes -->
    <div id="note-detail-container" style="display:none;">
      <div id="note-detail-title"></div>
      <div id="note-detail-category"></div>
      <div id="note-detail-content"></div>
      <div>
        <button onclick="openEditNoteForm(currentNoteId)">Editar</button>
        <button onclick="deleteNote(currentNoteId)">Excluir</button>
      </div>
    </div>

    <!-- Formulário de Adição/Edição -->
    <div id="note-form-container">
      <form id="note-form">
        <input type="hidden" id="form-note-id" value="">
        <input type="text" id="form-note-title" placeholder="Título" required />
        <input type="text" id="form-note-category" placeholder="Categoria" />
        <textarea id="form-note-content" placeholder="Conteúdo (use &#8627; para quebras de linha)"></textarea>
        <div>
          <button type="submit">Salvar</button>
          <button type="button" onclick="cancelForm()">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <div class="bottom-bar">
    <!-- Espaço reservado para futuros botões -->
  </div>

  <script>
    // --- CONFIGURAÇÃO INICIAL ---
    function getQueryParam(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }

    const WEB_APP_URL = getQueryParam("webAppUrl");
    console.log("WEB_APP_URL:", WEB_APP_URL);

    // --- VARIÁVEIS GLOBAIS ---
    let allNotes = [];
    let filteredNotes = [];
    let currentNoteId = null;

    // --- FUNÇÕES DE INTERFACE ---
    function showSection(sectionId) {
      console.log("Mostrando seção:", sectionId);
      
      // Esconde todas as seções
      document.getElementById("notes-list-container").style.display = "none";
      document.getElementById("note-detail-container").style.display = "none";
      document.getElementById("note-form-container").style.display = "none";
      document.getElementById("loading-message").style.display = "none";
      document.getElementById("error-message").style.display = "none";

      // Mostra a seção especificada
      if (sectionId) {
        const element = document.getElementById(sectionId);
        if (element) {
          element.style.display = "block";
          console.log("Seção exibida:", sectionId);
        } else {
          console.error("Elemento não encontrado:", sectionId);
        }
      }
    }

    function displayErrorMessage(message) {
      console.error("Erro:", message);
      document.getElementById("error-message").textContent = message;
      document.getElementById("error-message").style.display = "block";
      showSection();
    }

    function updateNoteCounter() {
      const counterElement = document.getElementById("noteCounter");
      counterElement.textContent = `${filteredNotes.length} anotaç${filteredNotes.length === 1 ? "ão" : "ões"}`;
    }

    function populateCategoryFilter() {
      const categories = [...new Set(allNotes.map(note => note.category).filter(cat => cat))];
      const filterSelect = document.getElementById("categoryFilter");
      filterSelect.innerHTML = "<option value=\"\">Todas as Categorias</option>";
      categories.forEach(category => {
        const option = document.createElement("option");
        option.value = category;
        option.textContent = category;
        filterSelect.appendChild(option);
      });
    }

    // --- FUNÇÕES DE EXIBIÇÃO DE DADOS ---
    function displayNotesList() {
       const listElement = document.getElementById("notes-list");
       listElement.innerHTML = "";

       filteredNotes.forEach(note => {
         const listItem = document.createElement("li");
         listItem.className = "note-item";
         if (note.id === currentNoteId) {
             listItem.classList.add("active");
         }
         listItem.dataset.id = note.id;
         listItem.innerHTML = `
             <div class="note-title">${note.title}</div>
             <div class="note-category">${note.category || "Sem categoria"}</div>
         `;
         listItem.addEventListener("click", () => showNoteDetails(note.id));
         listElement.appendChild(listItem);
       });

       updateNoteCounter();
       showSection("notes-list-container");
    }

    function showNoteDetails(noteId) {
        const note = allNotes.find(n => n.id == noteId);
        if (!note) {
            console.error("Anotação não encontrada:", noteId);
            return;
        }
        currentNoteId = note.id;

        document.getElementById("note-detail-title").textContent = note.title;
        document.getElementById("note-detail-category").textContent = note.category ? `Categoria: ${note.category}` : "";
        document.getElementById("note-detail-content").textContent = note.content.replace(/&#8627;/g, "\n");

        document.querySelectorAll(".note-item").forEach(item => {
            item.classList.remove("active");
            if (item.dataset.id == note.id) {
                item.classList.add("active");
            }
        });

        showSection("note-detail-container");
    }

    // --- FUNÇÕES DE FORMULÁRIO ---
    function openAddNoteForm() {
        console.log("Abrindo formulário de nova anotação");
        
        // Limpa os campos do formulário
        document.getElementById("form-note-id").value = "";
        document.getElementById("form-note-title").value = "";
        document.getElementById("form-note-category").value = "";
        document.getElementById("form-note-content").value = "";
        
        // Mostra o formulário
        showSection("note-form-container");
        
        // Foca no campo título
        setTimeout(() => {
            document.getElementById("form-note-title").focus();
        }, 100);
    }

    function openEditNoteForm(noteId) {
        console.log("Abrindo formulário de edição para:", noteId);
        
        const note = allNotes.find(n => n.id == noteId);
        if (!note) {
            console.error("Anotação não encontrada para edição:", noteId);
            return;
        }
        
        document.getElementById("form-note-id").value = note.id;
        document.getElementById("form-note-title").value = note.title;
        document.getElementById("form-note-category").value = note.category || "";
        document.getElementById("form-note-content").value = note.content;
        
        showSection("note-form-container");
        
        // Foca no campo título
        setTimeout(() => {
            document.getElementById("form-note-title").focus();
        }, 100);
    }

    function cancelForm() {
        console.log("Cancelando formulário");
        
        if (currentNoteId && allNotes.some(n => n.id == currentNoteId)) {
            showNoteDetails(currentNoteId);
        } else if (filteredNotes.length > 0) {
            showNoteDetails(filteredNotes[0].id);
        } else {
            displayNotesList();
        }
    }

    // --- FUNÇÕES DE FILTRO E BUSCA ---
    function filterNotes() {
        const searchTerm = document.getElementById("searchInput").value.toLowerCase();
        const categoryFilter = document.getElementById("categoryFilter").value;

        filteredNotes = allNotes.filter(note => {
            const matchesSearch = note.title.toLowerCase().includes(searchTerm) ||
                                  note.content.toLowerCase().includes(searchTerm) ||
                                  (note.category && note.category.toLowerCase().includes(searchTerm));
            const matchesCategory = categoryFilter === "" || note.category === categoryFilter;
            return matchesSearch && matchesCategory;
        });

        displayNotesList();
    }

    // --- FUNÇÕES DE COMUNICAÇÃO COM O BACKEND ---
    async function loadNotes() {
        console.log("Iniciando loadNotes...");
        if (!WEB_APP_URL) {
             displayErrorMessage("Erro: 'webAppUrl' não foi fornecido nos parâmetros da URL. Ex: ?webAppUrl=URL_DO_WEB_APP.");
             return;
        }
        try {
            showSection("loading-message");
            console.log("Fazendo fetch para:", `${WEB_APP_URL}?action=read`);
            
            const response = await fetch(`${WEB_APP_URL}?action=read`, {
                method: "GET",
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }
            });

            console.log("Response status:", response.status);
            console.log("Response headers:", response.headers);

            if (!response.ok) {
                const errorText = await response.text();
                console.error("Erro na resposta:", errorText);
                throw new Error(`Erro ao carregar dados: ${response.status} - ${errorText}`);
            }

            const responseText = await response.text();
            console.log("Response text:", responseText);

            let jsonData;
            try {
                jsonData = JSON.parse(responseText);
            } catch (parseError) {
                console.error("Erro ao fazer parse do JSON:", parseError);
                throw new Error(`Resposta não é um JSON válido: ${responseText}`);
            }

            console.log("Dados recebidos do backend:", jsonData);

            if (jsonData.error) {
                 displayErrorMessage(`Erro do servidor: ${jsonData.error}`);
                 return;
            }

            if (!Array.isArray(jsonData) || jsonData.length === 0) {
                 allNotes = [];
                 filteredNotes = [];
                 populateCategoryFilter();
                 updateNoteCounter();
                 showSection("notes-list-container"); // Mostra a lista vazia
                 return;
            }

            allNotes = jsonData.map(item => ({
                id: item["ID"] || item["id"] || "",
                title: item["Título"] || item["Titulo"] || item["title"] || "Sem título",
                content: item["Conteúdo"] || item["Conteudo"] || item["content"] || "",
                category: item["Categoria"] || item["category"] || "",
                created: item["Data de Criação"] || item["Data de Criacao"] || item["created"] || "",
                modified: item["Data de Modificação"] || item["Data de Modificacao"] || item["modified"] || ""
            }));

            filteredNotes = [...allNotes];
            populateCategoryFilter();
            filterNotes();
            if (filteredNotes.length > 0) {
                showNoteDetails(filteredNotes[0].id);
            } else {
                showSection("notes-list-container");
            }
            updateNoteCounter();

        } catch (error) {
            console.error("Erro ao carregar anotações:", error);
            displayErrorMessage(`Falha ao carregar anotações: ${error.message}`);
        }
    }

    async function saveNote() {
        console.log("Salvando anotação...");
        
        if (!WEB_APP_URL) {
             alert("Erro: 'webAppUrl' não foi fornecido. Não é possível salvar.");
             return;
        }
        
        const id = document.getElementById("form-note-id").value;
        const title = document.getElementById("form-note-title").value.trim();
        const category = document.getElementById("form-note-category").value.trim();
        const content = document.getElementById("form-note-content").value;

        if (!title) {
            alert("O título é obrigatório.");
            document.getElementById("form-note-title").focus();
            return;
        }

        const formData = new FormData();
        formData.append("action", id ? "update" : "create");
        if (id) formData.append("id", id);
        formData.append("title", title);
        formData.append("content", content);
        formData.append("category", category);

        try {
            const response = await fetch(WEB_APP_URL, {
                method: "POST",
                body: formData
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Erro na requisição: ${response.status} - ${errorText}`);
            }

            const result = await response.json();

            if (result.error) {
                alert(`Erro: ${result.error}`);
                return;
            }

            if (result.success) {
                alert(result.message || "Operação realizada com sucesso!");
                await loadNotes(); // Recarrega as anotações
            }

        } catch (error) {
            console.error("Erro ao salvar anotação:", error);
            alert(`Falha ao salvar anotação: ${error.message}`);
        }
    }

    async function deleteNote(noteId) {
        console.log("Excluindo anotação:", noteId);
        
        if (!WEB_APP_URL) {
             alert("Erro: 'webAppUrl' não foi fornecido. Não é possível excluir.");
             return;
        }
        if (!noteId) {
            alert("Erro: ID da anotação não encontrado.");
            return;
        }

        if (!confirm("Tem certeza que deseja excluir esta anotação?")) {
            return;
        }

        const formData = new FormData();
        formData.append("action", "delete");
        formData.append("id", noteId);

        try {
            const response = await fetch(WEB_APP_URL, {
                method: "POST",
                body: formData
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Erro na requisição: ${response.status} - ${errorText}`);
            }

            const result = await response.json();

            if (result.error) {
                alert(`Erro: ${result.error}`);
                return;
            }

            if (result.success) {
                alert(result.message || "Anotação excluída com sucesso!");
                await loadNotes(); // Recarrega as anotações
            }

        } catch (error) {
            console.error("Erro ao excluir anotação:", error);
            alert(`Falha ao excluir anotação: ${error.message}`);
        }
    }

    // --- EVENT LISTENERS E INICIALIZAÇÃO ---
    document.addEventListener("DOMContentLoaded", function() {
        console.log("DOM carregado, inicializando aplicação...");
        console.log("WEB_APP_URL configurado:", WEB_APP_URL);
        
        // Event listener para o formulário
        const form = document.getElementById("note-form");
        if (form) {
            form.addEventListener("submit", function(e) {
                e.preventDefault();
                console.log("Formulário submetido");
                saveNote();
            });
        }

        // Carrega as anotações ao inicializar
        loadNotes();
        
        console.log("Aplicação inicializada");
    });

    // Função de teste para debug
    function testOpenForm() {
        console.log("Teste: abrindo formulário");
        openAddNoteForm();
    }

    // Função de teste para verificar se o botão funciona
    window.testButton = function() {
        console.log("Botão testado!");
        openAddNoteForm();
    };
  </script>
</body>
</html>

